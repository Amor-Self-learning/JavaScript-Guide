# Module 10: OS

The `os` module provides operating system-related utility methods and properties. It's essential for writing cross-platform code and system monitoring applications.

---

## 10.1 Module Import

```javascript
// CommonJS
const os = require('os');

// ES Modules
import os from 'os';
import { cpus, freemem, totalmem } from 'os';
```

---

## 10.2 System Information

### Platform and Architecture

```javascript
// Operating system platform
console.log(os.platform());
// 'linux', 'darwin' (macOS), 'win32', 'freebsd', etc.

// CPU architecture
console.log(os.arch());
// 'x64', 'arm', 'arm64', 'ia32', etc.

// Operating system name
console.log(os.type());
// 'Linux', 'Darwin', 'Windows_NT'

// OS version
console.log(os.version());
// 'Darwin Kernel Version 23.0.0...'

// OS release
console.log(os.release());
// '23.0.0' on macOS, '5.15.0-generic' on Linux

// Machine type (Node.js 18+)
console.log(os.machine());
// 'x86_64', 'arm64', etc.
```

### Endianness

```javascript
// Byte order
console.log(os.endianness());
// 'LE' (little-endian) or 'BE' (big-endian)
```

---

## 10.3 Memory Information

```javascript
// Total system memory in bytes
const totalMem = os.totalmem();
console.log(`Total: ${(totalMem / 1024 / 1024 / 1024).toFixed(2)} GB`);
// Total: 16.00 GB

// Free memory in bytes
const freeMem = os.freemem();
console.log(`Free: ${(freeMem / 1024 / 1024 / 1024).toFixed(2)} GB`);
// Free: 4.50 GB

// Memory usage percentage
const usedPercent = ((totalMem - freeMem) / totalMem * 100).toFixed(1);
console.log(`Used: ${usedPercent}%`);
// Used: 71.9%
```

### Memory Helper Functions

```javascript
function formatBytes(bytes, decimals = 2) {
  if (bytes === 0) return '0 Bytes';
  
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
}

console.log(formatBytes(os.totalmem()));  // '16 GB'
console.log(formatBytes(os.freemem()));   // '4.5 GB'
```

---

## 10.4 CPU Information

### cpu() Array

```javascript
const cpus = os.cpus();

console.log(`CPU Cores: ${cpus.length}`);

// Each CPU entry
cpus.forEach((cpu, index) => {
  console.log(`CPU ${index}:`);
  console.log(`  Model: ${cpu.model}`);
  console.log(`  Speed: ${cpu.speed} MHz`);
  console.log(`  Times:`, cpu.times);
});

// Output:
// CPU 0:
//   Model: Apple M1 Pro
//   Speed: 3220
//   Times: { user: 12345, nice: 0, sys: 5432, idle: 98765, irq: 0 }
```

### CPU Usage Calculation

```javascript
function getCPUUsage() {
  const cpus = os.cpus();
  let totalIdle = 0;
  let totalTick = 0;
  
  for (const cpu of cpus) {
    for (const type in cpu.times) {
      totalTick += cpu.times[type];
    }
    totalIdle += cpu.times.idle;
  }
  
  return {
    idle: totalIdle / cpus.length,
    total: totalTick / cpus.length,
    usage: ((1 - totalIdle / totalTick) * 100).toFixed(1)
  };
}

console.log(`CPU Usage: ${getCPUUsage().usage}%`);
```

### CPU Usage Over Time

```javascript
function measureCPU(interval = 1000) {
  const startMeasure = getCPUInfo();
  
  return new Promise(resolve => {
    setTimeout(() => {
      const endMeasure = getCPUInfo();
      
      const idleDiff = endMeasure.idle - startMeasure.idle;
      const totalDiff = endMeasure.total - startMeasure.total;
      const usage = 100 - (idleDiff / totalDiff * 100);
      
      resolve(usage.toFixed(1));
    }, interval);
  });
}

function getCPUInfo() {
  const cpus = os.cpus();
  let idle = 0, total = 0;
  
  for (const cpu of cpus) {
    for (const type in cpu.times) {
      total += cpu.times[type];
    }
    idle += cpu.times.idle;
  }
  
  return { idle, total };
}

// Usage
const usage = await measureCPU(1000);
console.log(`CPU Usage (1s): ${usage}%`);
```

---

## 10.5 Load Average

```javascript
// 1, 5, and 15 minute load averages
const [load1, load5, load15] = os.loadavg();

console.log(`Load Average: ${load1.toFixed(2)}, ${load5.toFixed(2)}, ${load15.toFixed(2)}`);
// Load Average: 2.45, 2.12, 1.98

// Note: Returns [0, 0, 0] on Windows
```

---

## 10.6 User Information

```javascript
// Current user info
const userInfo = os.userInfo();

console.log(userInfo);
// {
//   uid: 501,
//   gid: 20,
//   username: 'john',
//   homedir: '/Users/john',
//   shell: '/bin/zsh'
// }

// On Windows, uid and gid are -1, shell is null

// Home directory (alternative)
console.log(os.homedir());
// '/Users/john' or 'C:\\Users\\john'

// Temp directory
console.log(os.tmpdir());
// '/tmp' or 'C:\\Users\\john\\AppData\\Local\\Temp'
```

---

## 10.7 Network Interfaces

```javascript
const interfaces = os.networkInterfaces();

console.log(interfaces);
// {
//   lo: [
//     { address: '127.0.0.1', netmask: '255.0.0.0', family: 'IPv4', ... }
//   ],
//   eth0: [
//     { address: '192.168.1.100', netmask: '255.255.255.0', family: 'IPv4', ... },
//     { address: 'fe80::1', netmask: 'ffff:ffff:ffff:ffff::', family: 'IPv6', ... }
//   ]
// }
```

### Get Local IP Address

```javascript
function getLocalIP() {
  const interfaces = os.networkInterfaces();
  
  for (const name of Object.keys(interfaces)) {
    for (const iface of interfaces[name]) {
      // Skip internal (loopback) and non-IPv4
      if (!iface.internal && iface.family === 'IPv4') {
        return iface.address;
      }
    }
  }
  
  return '127.0.0.1';
}

console.log(`Local IP: ${getLocalIP()}`);
// Local IP: 192.168.1.100
```

### Get All IP Addresses

```javascript
function getAllIPs() {
  const interfaces = os.networkInterfaces();
  const ips = [];
  
  for (const [name, ifaces] of Object.entries(interfaces)) {
    for (const iface of ifaces) {
      if (!iface.internal) {
        ips.push({
          interface: name,
          address: iface.address,
          family: iface.family,
          mac: iface.mac
        });
      }
    }
  }
  
  return ips;
}

console.log(getAllIPs());
```

---

## 10.8 System Uptime

```javascript
// System uptime in seconds
const uptime = os.uptime();

console.log(`Uptime: ${uptime} seconds`);

// Format uptime
function formatUptime(seconds) {
  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  
  const parts = [];
  if (days > 0) parts.push(`${days}d`);
  if (hours > 0) parts.push(`${hours}h`);
  if (minutes > 0) parts.push(`${minutes}m`);
  parts.push(`${secs}s`);
  
  return parts.join(' ');
}

console.log(`Uptime: ${formatUptime(os.uptime())}`);
// Uptime: 5d 12h 34m 56s
```

---

## 10.9 Hostname

```javascript
console.log(os.hostname());
// 'my-macbook.local'
```

---

## 10.10 End-of-Line Character

```javascript
// Platform-specific newline
console.log(os.EOL);
// '\n' on POSIX (Linux, macOS)
// '\r\n' on Windows

// Use for cross-platform text files
const lines = ['Line 1', 'Line 2', 'Line 3'];
const content = lines.join(os.EOL);
```

---

## 10.11 Process Priority

```javascript
// Get current process priority
console.log(os.getPriority());
// 0 (normal priority)

// Get priority of specific process
console.log(os.getPriority(process.pid));

// Set priority (requires permissions)
try {
  os.setPriority(process.pid, 10);  // Lower priority
  os.setPriority(process.pid, -10); // Higher priority (may need root)
} catch (err) {
  console.error('Cannot set priority:', err.message);
}

// Priority constants
// -20: Highest priority
// 0: Normal priority
// 19: Lowest priority (Linux)
```

---

## 10.12 Available Parallelism

```javascript
// Recommended number of parallel operations (Node.js 19+)
console.log(os.availableParallelism());
// 8 (number of logical cores)

// Fallback for older Node.js
const parallelism = os.availableParallelism?.() ?? os.cpus().length;
```

---

## 10.13 Constants

```javascript
// Signal constants
console.log(os.constants.signals.SIGINT);   // 2
console.log(os.constants.signals.SIGTERM);  // 15
console.log(os.constants.signals.SIGKILL);  // 9

// Error constants
console.log(os.constants.errno.ENOENT);     // 2 (No such file)
console.log(os.constants.errno.EACCES);     // 13 (Permission denied)
console.log(os.constants.errno.ECONNREFUSED); // 111

// Priority constants
console.log(os.constants.priority.PRIORITY_LOW);      // 19
console.log(os.constants.priority.PRIORITY_NORMAL);   // 0
console.log(os.constants.priority.PRIORITY_HIGH);     // -7
```

---

## 10.14 Common Patterns

### System Monitor

```javascript
function getSystemInfo() {
  const cpus = os.cpus();
  
  return {
    platform: os.platform(),
    arch: os.arch(),
    hostname: os.hostname(),
    uptime: formatUptime(os.uptime()),
    memory: {
      total: formatBytes(os.totalmem()),
      free: formatBytes(os.freemem()),
      used: formatBytes(os.totalmem() - os.freemem()),
      usedPercent: ((1 - os.freemem() / os.totalmem()) * 100).toFixed(1) + '%'
    },
    cpu: {
      model: cpus[0].model,
      cores: cpus.length,
      speed: cpus[0].speed + ' MHz'
    },
    loadAvg: os.loadavg().map(n => n.toFixed(2)).join(', '),
    user: os.userInfo().username
  };
}

console.log(getSystemInfo());
```

### Environment Detection

```javascript
const isWindows = os.platform() === 'win32';
const isMac = os.platform() === 'darwin';
const isLinux = os.platform() === 'linux';

const is64bit = os.arch() === 'x64' || os.arch() === 'arm64';
const isARM = os.arch().startsWith('arm');

console.log({ isWindows, isMac, isLinux, is64bit, isARM });
```

### Resource Monitoring

```javascript
class ResourceMonitor {
  constructor(interval = 5000) {
    this.interval = interval;
    this.timer = null;
    this.history = [];
  }
  
  start() {
    this.timer = setInterval(() => {
      const snapshot = {
        timestamp: Date.now(),
        memory: {
          total: os.totalmem(),
          free: os.freemem(),
          used: os.totalmem() - os.freemem()
        },
        loadAvg: os.loadavg(),
        uptime: os.uptime()
      };
      
      this.history.push(snapshot);
      
      // Keep last 100 entries
      if (this.history.length > 100) {
        this.history.shift();
      }
      
      this.emit('snapshot', snapshot);
    }, this.interval);
  }
  
  stop() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }
  
  getAverage() {
    if (this.history.length === 0) return null;
    
    const sum = this.history.reduce((acc, s) => ({
      memoryUsed: acc.memoryUsed + s.memory.used,
      load: acc.load + s.loadAvg[0]
    }), { memoryUsed: 0, load: 0 });
    
    return {
      avgMemoryUsed: sum.memoryUsed / this.history.length,
      avgLoad: sum.load / this.history.length
    };
  }
}
```

### Cross-Platform Paths

```javascript
function getCachePath(appName) {
  const home = os.homedir();
  
  switch (os.platform()) {
    case 'win32':
      return path.join(home, 'AppData', 'Local', appName, 'Cache');
    case 'darwin':
      return path.join(home, 'Library', 'Caches', appName);
    default:
      return path.join(home, '.cache', appName);
  }
}

function getConfigPath(appName) {
  const home = os.homedir();
  
  switch (os.platform()) {
    case 'win32':
      return path.join(home, 'AppData', 'Roaming', appName);
    case 'darwin':
      return path.join(home, 'Library', 'Application Support', appName);
    default:
      return path.join(home, '.config', appName);
  }
}
```

---

## 10.15 Summary

| Method | Description |
|--------|-------------|
| `platform()` | OS platform (linux, darwin, win32) |
| `arch()` | CPU architecture (x64, arm64) |
| `type()` | OS name (Linux, Darwin, Windows_NT) |
| `release()` | OS release version |
| `version()` | OS version string |
| `hostname()` | Machine hostname |
| `uptime()` | System uptime in seconds |

| Memory | Description |
|--------|-------------|
| `totalmem()` | Total memory in bytes |
| `freemem()` | Free memory in bytes |

| CPU | Description |
|-----|-------------|
| `cpus()` | Array of CPU info |
| `loadavg()` | 1, 5, 15 minute load averages |
| `availableParallelism()` | Recommended parallelism |

| User/System | Description |
|-------------|-------------|
| `userInfo()` | Current user info |
| `homedir()` | User home directory |
| `tmpdir()` | Temp directory |
| `networkInterfaces()` | Network interfaces |
| `EOL` | Platform line ending |

---

**End of Module 10: OS**

Next: **Module 11 â€” Crypto** (Cryptographic operations)
